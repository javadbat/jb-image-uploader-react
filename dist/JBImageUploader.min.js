import React from"react";import{extendObservable,observable,computed}from"mobx";import UploadFileRequest from"jb-modules/RequestModule/dist/UploadFileRequest.min";import ReactDOM from"react-dom";import"./JBImageUploader.css";import{observer}from"mobx-react";var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_temp;function _initializerDefineProperty(a,b,c,d){c&&Object.defineProperty(a,b,{enumerable:c.enumerable,configurable:c.configurable,writable:c.writable,value:c.initializer?c.initializer.call(d):void 0})}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _applyDecoratedDescriptor(a,b,c,d,e){var f={};return Object.keys(d).forEach(function(a){f[a]=d[a]}),f.enumerable=!!f.enumerable,f.configurable=!!f.configurable,("value"in f||f.initializer)&&(f.writable=!0),f=c.slice().reverse().reduce(function(c,d){return d(a,b,c)||c},f),e&&void 0!==f.initializer&&(f.value=f.initializer?f.initializer.call(e):void 0,f.initializer=void 0),void 0===f.initializer&&(Object.defineProperty(a,b,f),f=null),f}var _class$1,JBImageUploaderService=(_class=(_temp=function(){function a(b){var c=this;_classCallCheck(this,a),this.defaultConfig={urls:{showImage:"",uploadImage:""},deletable:!1,JBImageEditorConfig:{callBacks:{onClose:function(){return c.onImageEditorClosed()},onApprove:function(a){return c.onImageEditorApproved(a)}}},triggers:{lock:function(a){c.lock(a)},unlock:function(){c.unlock()},reUploadImage:function(){c.uploadImage()}},acceptType:"image/jpeg,image/jpg,image/png",openImageEditorCondition:function(a){return!0==a.ctrlKey}},this.config=null,_initializerDefineProperty(this,"progressPercent",_descriptor,this),_initializerDefineProperty(this,"status",_descriptor2,this),this.useImageEditor=!1,this.virtualInputFile=void 0,this.selectedImageType=void 0,this.elements={imageEditorDOM:null},_initializerDefineProperty(this,"value",_descriptor3,this),_initializerDefineProperty(this,"isLock",_descriptor4,this),_initializerDefineProperty(this,"lockText",_descriptor5,this),this.inUploadImageFile=null,this.props=b,this.value=b.value,this.config=this.mergeObject(b.config,this.defaultConfig),this.createVirtualInputFile(),this.value&&(this.status="has_value")}return _createClass(a,[{key:"mergeObject",value:function(a,b){var c={};for(var d in b)(null==a[d]||null==a[d])&&(c[d]=b[d]);return extendObservable(a,c),a}},{key:"createVirtualInputFile",value:function(){var a=this;this.virtualInputFile=document.createElement("input"),this.virtualInputFile.type="file",this.virtualInputFile.accept=this.config.acceptType,this.virtualInputFile.addEventListener("change",function(b){return a.onImageSelected(b)})}},{key:"openSelectImageDialog",value:function(a){var b;b="function"==typeof this.config.openImageEditorCondition?this.config.openImageEditorCondition.call(this,a):this.config.openImageEditorCondition,b&&(this.useImageEditor=!0),a.target.closest(".action-bar")||("empty"==this.status||"has_value"==this.status)&&this.virtualInputFile.click()}},{key:"onImageSelected",value:function(a){0<a.target.files.length&&(this.config.JBImageEditorConfig&&this.useImageEditor?(this.selectedImageType=a.target.files[0].type,this.initImageEditor(a.target.files[0])):(this.inUploadImageFile=a.target.files[0],this.uploadImage(),this.useImageEditor=!1,this.selectedImageType=a.target.files[0].type))}},{key:"uploadImage",value:function(){var a=this;this.status="updating";new UploadFileRequest({url:this.config.urls.uploadImage,file:this.inUploadImageFile,onSuccess:function(b){return a.onSuccessImageUpload(b)},onError:function(b){return a.onErrorImageUpload(b)},onProgress:function(b){return a.onProgressImageUpload(b)}})}},{key:"onSuccessImageUpload",value:function(a){this.props.onSuccess&&this.props.onSuccess(a)}},{key:"onErrorImageUpload",value:function(a){this.status=this.props.value?"has_value":"empty",this.virtualInputFile.value="",this.props.onError&&this.props.onError(a)}},{key:"onProgressImageUpload",value:function(a){this.progressPercent=a,this.props.onProgress&&this.props.onProgress(a)}},{key:"onDeleteImageBtnClicked",value:function(a){this.props.onDelete&&this.props.onDelete(a)}},{key:"initImageEditor",value:function(a){var b=this;this.elements.imageEditorDOM=document.createElement("div"),this.elements.imageEditorDOM.classList.add("jb-image-editor-float-container");var c=document.getElementsByTagName("body");c[0].appendChild(this.elements.imageEditorDOM),System.import("ReactComponents/JBImageEditor/JBImageEditor.js").then(function(c){var d=c.default;ReactDOM.render(React.createElement(d,{config:b.config.JBImageEditorConfig,imageFile:a}),b.elements.imageEditorDOM,b.onImageEditorLoadComplete())})}},{key:"onImageEditorLoadComplete",value:function(){}},{key:"onImageEditorClosed",value:function(){this.virtualInputFile.value="",this.elements.imageEditorDOM.parentNode.removeChild(this.elements.imageEditorDOM),this.elements.imageEditorDOM=null}},{key:"onImageEditorApproved",value:function(a){var b=this.dataURItoBlob(a);this.uploadImage(b),this.useImageEditor=!1,this.virtualInputFile.value="",this.elements.imageEditorDOM.parentNode.removeChild(this.elements.imageEditorDOM),this.elements.imageEditorDOM=null}},{key:"dataURItoBlob",value:function(a){for(var b=atob(a.split(",")[1]),c=[],d=0;d<b.length;d++)c.push(b.charCodeAt(d));return new Blob([new Uint8Array(c)],{type:this.selectedImageType})}},{key:"lock",value:function(a){"string"==typeof a&&(this.lockText=a),this.isLock=!0}},{key:"unlock",value:function(){this.isLock=!1}},{key:"getPreviewImageURL",get:function(){return this.value?this.config.urls.showImage.replace("{value}",this.value):null}}]),a}(),_temp),_descriptor=_applyDecoratedDescriptor(_class.prototype,"progressPercent",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"status",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"empty"}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"value",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"isLock",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"lockText",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Lock"}}),_applyDecoratedDescriptor(_class.prototype,"getPreviewImageURL",[computed],Object.getOwnPropertyDescriptor(_class.prototype,"getPreviewImageURL"),_class.prototype),_class);function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck$1(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties$1(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass$1(a,b,c){return b&&_defineProperties$1(a.prototype,b),c&&_defineProperties$1(a,c),a}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}var JBImageUploader=observer(_class$1=function(a){function b(a){var c;return _classCallCheck$1(this,b),c=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this,a)),c.service=new JBImageUploaderService(a),c.service.props=c.props,c}return _inherits(b,a),_createClass$1(b,[{key:"componentWillReceiveProps",value:function(a){this.service.value!=a.value&&(this.service.value=a.value,this.service.status=a.value?"has_value":"empty")}},{key:"render",value:function(){var a=this,b=React.createElement("div",{className:"jb-image-uploader-component"},React.createElement("section",{className:"bg-wrapper "+("empty"==this.service.status?"":"hide"),onClick:function(b){return a.service.openSelectImageDialog(b)}},React.createElement("div",{className:"icon-wrapper"},React.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",viewBox:"0 0 308.8 308.8"},React.createElement("g",null,React.createElement("path",{style:{fill:"#4A566E"},d:"M35.6,18.8h180c19.6,0,35.6,16,35.6,35.6v185.2c0,19.6-16,35.6-35.6,35.6h-180   C16,275.2,0,259.2,0,239.6V54C0,34.8,16,18.8,35.6,18.8z"}),React.createElement("path",{style:{fill:"#00B594"},d:"M116.4,186.4l-52.8-52.8L0,197.2v13.2v28.8c0,19.6,16,35.6,35.6,35.6h180c19.6,0,35.6-16,35.6-35.6   v-28.8v-39.6l-59.6-60L116.4,186.4z"}),React.createElement("circle",{style:{fill:"#FFCC03"},cx:"114.8",cy:"103.6",r:"22.4"}),React.createElement("circle",{style:{fill:"#FFFFFF"},cx:"251.2",cy:"232.4",r:"57.6"})),React.createElement("g",null,React.createElement("path",{style:{fill:"#00B594"},d:"M242.8,205.6c0-4.8,3.6-8.4,8.4-8.4c4.4,0,8.4,3.6,8.4,8.4V260c0,4.8-3.6,8.4-8.4,8.4   s-8.4-3.6-8.4-8.4V205.6z"}),React.createElement("path",{style:{fill:"#00B594"},d:"M245.2,211.2c-3.2-3.2-3.2-8.4,0-11.6s8.4-3.2,11.6,0l19.2,19.2c3.2,3.2,3.2,8.4,0,11.6   s-8.4,3.2-11.6,0L245.2,211.2z"}),React.createElement("path",{style:{fill:"#00B594"},d:"M245.2,199.6c3.2-3.2,8.4-3.2,11.6,0s3.2,8.4,0,11.6L238,230.4c-3.2,3.2-8.4,3.2-11.6,0   s-3.2-8.4,0-11.6L245.2,199.6z"})))),React.createElement("div",{className:"caption"},"\u062A\u0635\u0648\u06CC\u0631\u06CC \u0627\u0646\u062A\u062E\u0627\u0628 \u0646\u0634\u062F\u0647 \u0627\u0633\u062A \u0628\u0631\u0627\u06CC \u0627\u0646\u062A\u062E\u0627\u0628 \u062A\u0635\u0648\u06CC\u0631 \u06A9\u0644\u06CC\u06A9 \u06A9\u0646\u06CC\u062F")),React.createElement("section",{className:"image-wrapper "+("has_value"==this.service.status?"":"hide"),onClick:function(b){return a.service.openSelectImageDialog(b)}},this.service.getPreviewImageURL&&React.createElement("img",{className:"image-showcase",src:this.service.getPreviewImageURL}),React.createElement("div",{className:"action-bar"},this.service.config.deletable&&React.createElement("div",{className:"delete-image-btn",onClick:function(b){return a.service.onDeleteImageBtnClicked(b)}},React.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",version:"1.1",x:"0px",y:"0px",viewBox:"0 0 512 512",space:"preserve"},React.createElement("g",null,React.createElement("g",null,React.createElement("path",{className:"door",d:"M381.621,65.523h-53.943V54.004C327.678,24.226,303.451,0,273.673,0h-35.346c-29.778,0-54.005,24.226-54.005,54.004    v11.519h-53.943c-34.76,0-63.04,28.28-63.04,63.04v15.975H444.66v-15.976C444.66,93.803,416.38,65.523,381.621,65.523z     M297.261,65.523H214.74V54.004c0-13.005,10.581-23.587,23.588-23.587h35.346c13.006,0,23.588,10.581,23.588,23.587V65.523z"}))),React.createElement("g",null,React.createElement("g",null,React.createElement("path",{d:"M88.452,174.955v306.112c0,17.056,13.877,30.933,30.934,30.933h273.227c17.057,0,30.934-13.877,30.934-30.933V174.955    H88.452z M197.532,466.16h-30.417V220.795h30.417V466.16z M271.208,466.16h-30.417V220.795h30.417V466.16z M344.886,466.16    h-30.417V220.795h30.417V466.16z"}))))))),React.createElement("section",{className:"progress-bg-wrapper "+("updating"==this.service.status?"":"hide")},"\u062F\u0631 \u062D\u0627\u0644 \u0622\u067E\u0644\u0648\u062F"),React.createElement("section",{className:"progress-wrapper "+("updating"==this.service.status?"":"hide"),style:{width:this.service.progressPercent+"%"}}),React.createElement("section",{className:"lock-panel-wrapper "+(this.service.isLock?"":"hide")},this.service.lockText));return b}}]),b}(React.Component))||_class$1;export default JBImageUploader;
